<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Chantier - 2HR Habitat RÃ©novation</title>
    
    <style>
        :root {
            --company-orange: #E57300;
            --company-light-green: #E2EFDA;
            --company-dark-green-action: #3E8E41;
            --text-dark: #333333;
            --text-light: #FFFFFF;
            --border-color: #cccccc;
            --error-red: #dc3545;
            --button-danger: #d9534f;
            --button-danger-hover: #c9302c;
            --button-info: #5bc0de;
            --button-info-hover: #31b0d5;
            --status-orange: #f0ad4e;
            --status-green: #5cb85c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .company-logo { display: block; margin: 0 auto 20px auto; max-height: 120px; width: auto; }
        .app-header { background-color: #ffffff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--company-orange); margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .app-header .company-logo { margin: 0; max-height: 50px; }
        .app-header h1 { margin: 0 20px; flex-grow: 1; font-size: 1.5em; color: var(--company-orange); }
        #login-container, #app-container { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin: 20px auto; max-width: 900px; }
        #login-container { max-width: 400px; text-align: center; }

        h2, h3, h4 { color: var(--company-orange); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 25px; }
        h2:first-child, h3:first-child, h4:first-child { margin-top: 0; }
        h4 { font-size: 1.1em; border-bottom: none; }

        input, textarea, select, button { font-family: inherit; font-size: 1em; }
        input[type="email"], input[type="password"], input[type="text"], input[type="tel"], input[type="date"], input[type="file"], textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; background-color: #fff; }
        input[type="file"] { padding: 5px; }
        textarea { min-height: 80px; resize: vertical; }

        button { background-color: var(--company-orange); color: var(--text-light); padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: background-color 0.2s ease; }
        button:hover { background-color: #D46900; }
        #logout-button { background-color: #6c757d; }
        #logout-button:hover { background-color: #5a6268; }
        .delete-client-button, .delete-button { background-color: var(--button-danger); }
        .delete-client-button:hover, .delete-button:hover { background-color: var(--button-danger-hover); }
        .delete-client-button:disabled, .delete-button:disabled { background-color: #aaa; }
        .edit-chantier-button { background-color: var(--button-info); }
        .edit-chantier-button:hover { background-color: var(--button-info-hover); }


        .error { color: var(--error-red); background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }
        .message-feedback { padding: 10px; border-radius: 4px; margin-top: 15px; border: 1px solid transparent; }
        .message-feedback.success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .message-feedback.error { color: var(--error-red); background-color: #f8d7da; border-color: #f5c6cb; }
        
        .client-accordion { border: 1px solid #d0d0d0; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        .client-header { cursor: pointer; padding: 15px 20px; background-color: #e2efda; transition: background-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--company-dark-green-action); }
        .client-header-content { flex-grow: 1; }
        .client-details-preview { font-size: 0.85em; color: #555; }
        .client-header-actions button { padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .client-header:hover { background-color: #d4e7c7; }
        .client-header.is-admin { cursor: default; background-color: #f1f1f1; border-bottom-color: #ccc; }
        .client-header.is-admin:hover { background-color: #f1f1f1; }
        .client-header h3 { margin: 0; padding: 0; border: none; color: var(--text-dark); font-size: 1.3em; }
        .indicator { transition: transform 0.3s ease; font-size: 1.5em; color: var(--company-dark-green-action) }
        .client-header.is-open > .indicator, .chantier-header.is-open > .indicator { transform: rotate(180deg); }
        .client-body, .chantier-body { display: none; padding: 15px; }
        .chantier-item { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .chantier-item:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .chantier-description { background-color: #f9f9f9; border-left: 3px solid var(--company-orange); padding: 10px; margin: 10px 0; border-radius: 4px; }
        
        .documents-section { margin-top: 20px; border-top: 1px dashed #ddd; padding-top: 20px; }
        .document-list { list-style: none; padding: 0; }
        .document-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .document-item:last-child { border-bottom: none; }
        .document-item a { text-decoration: none; color: var(--company-orange); font-weight: bold; }
        .document-info { flex-grow: 1; }
        .document-status { font-style: italic; font-size: 0.9em; margin-left: 15px; }
        .document-status.status-attente { color: var(--status-orange); }
        .document-status.status-valide { color: var(--status-green); }
        .document-actions { display: flex; align-items: center; gap: 10px; }
        .document-actions .delete-button { padding: 5px 8px; font-size: 0.8em; margin: 0; }
        .document-actions .validate-payment-button { background-color: var(--status-green); padding: 5px 8px; font-size: 0.8em; margin: 0; }
        .document-actions .validate-payment-button:hover { background-color: #4cae4c; }

        .photos-section { margin-top: 20px; border-top: 1px dashed #ddd; padding-top: 20px;}
        .photos-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 10px; background-color: #f4f7f6; border-radius: 5px; min-height: 50px; }
        .photo-wrapper { position: relative; }
        .photo-wrapper img { height: 100px; width: 100px; object-fit: cover; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
        .photo-wrapper img:hover { transform: scale(1.05); }
        .delete-photo-button { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; padding: 0; margin: 0; line-height: 24px; text-align: center; border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; }

        #admin-section { background-color: #fffaf5; padding: 20px; border-radius: 8px; border: 1px solid #ffe8cc; }
        .admin-subsection { margin-top: 25px; padding-top: 25px; border-top: 1px dashed #ddd; }
        .admin-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .admin-danger-zone { border: 1px solid red !important; padding: 15px; margin-top: 20px; }

        .chat-section { margin-top: 20px; border-top: 1px dashed #ddd; padding-top: 20px; }
        .chat-box { max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #f9f9f9; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 70%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .chat-message:hover .delete-message-button { opacity: 1; }
        .chat-message p { margin: 0; }
        .chat-message .meta { font-size: 0.75em; color: #6c757d; margin-top: 5px; }
        .message-sent { background-color: var(--company-orange); color: white; border-bottom-right-radius: 4px; align-self: flex-end; text-align: right; }
        .message-received { background-color: #e9ecef; color: #333; border-bottom-left-radius: 4px; align-self: flex-start; }
        .delete-message-button { position: absolute; top: -8px; padding: 0; width: 20px; height: 20px; line-height: 20px; font-size: 12px; border-radius: 50%; opacity: 0; transition: opacity 0.2s; }
        .message-sent .delete-message-button { left: -8px; }
        .message-received .delete-message-button { right: -8px; }
        .chat-form { display: flex; gap: 10px; margin-top: 15px; }
        .chat-form textarea { flex-grow: 1; margin: 0; }
        .chat-form button { margin-top: 0; align-self: flex-end; height: fit-content; }
        
        .chantier-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .chantier-actions button { margin-top: 0; font-size: 0.9em; padding: 8px 12px; }

        .admin-badge { background-color: var(--company-orange); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; margin-left: 10px; font-weight: bold; vertical-align: middle; }
        .lightbox { position: fixed; z-index: 1000; padding: 20px; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; overflow: auto; background-color: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; }
        .lightbox-content { margin: auto; display: block; max-width: 100%; max-height: 100%; border-radius: 8px; }
        .lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
    </style>
    <link rel="manifest" href="/manifest.json">
</head>
<body>
    <div id="login-container">
        <img src="./images/logo.png" alt="Logo 2HR Habitat RÃ©novation" id="login-logo" class="company-logo">
        <h2>Connexion</h2>
        <form id="login-form">
            <div><label for="email">E-mail :</label><input type="email" id="email" name="email" required></div>
            <div><label for="password">Mot de passe :</label><input type="password" id="password" name="password" required></div>
            <button type="submit">Se connecter</button>
            <p id="login-error" class="error" style="display: none;"></p>
        </form>
    </div>
    <div id="app-container" style="display: none;">
        <header class="app-header">
            <img src="./images/logo.png" alt="Logo 2HR Habitat RÃ©novation" id="app-logo" class="company-logo">
            <h1 id="app-title">Suivi de vos chantiers</h1>
            <button id="logout-button">Se dÃ©connecter</button>
        </header>
        <div id="chantiers-list"></div>
        <div id="admin-section" style="display: none;">
            <h2>Outils d'Administration</h2>
            <div class="admin-subsection">
                <h3>CrÃ©er un Nouveau Client</h3>
                <form id="create-client-form">
                    <div><label for="new-client-name">Nom du client :</label><input type="text" id="new-client-name" required></div>
                    <div><label for="new-client-email">Email du client :</label><input type="email" id="new-client-email" required></div>
                    <div><label for="new-client-phone">NÂ° de tÃ©lÃ©phone :</label><input type="tel" id="new-client-phone" placeholder="Ex: 0612345678"></div>
                    <div><label for="new-client-address">Adresse Postale :</label><input type="text" id="new-client-address"></div>
                    <div><label for="new-client-password">Mot de passe initial (6 caractÃ¨res min.) :</label><input type="text" id="new-client-password" required minlength="6"></div>
                    <button type="submit">CrÃ©er le Client</button>
                    <p id="create-client-status" class="message-feedback" style="display: none;"></p>
                </form>
            </div>
            <div class="admin-subsection">
                <h3>Ajouter un Nouveau Chantier</h3>
                 <form id="add-chantier-form">
                    <div><label for="add-chantier-client-select">Pour le client :</label><select id="add-chantier-client-select" required></select></div>
                    <div><label for="new-chantier-address">Adresse du chantier :</label><input type="text" id="new-chantier-address" required></div>
                    <div><label for="new-chantier-description">Description du chantier :</label><textarea id="new-chantier-description"></textarea></div>
                    <div><label for="new-chantier-start-date">Date de dÃ©but :</label><input type="date" id="new-chantier-start-date"></div>
                    <div><label for="new-chantier-end-date">Date de fin estimÃ©e :</label><input type="date" id="new-chantier-end-date"></div>
                    <button type="submit">Ajouter le Chantier</button>
                    <p id="add-chantier-status" class="message-feedback" style="display: none;"></p>
                </form>
            </div>
            <div class="admin-danger-zone">
                <h3>GÃ©rer les RÃ´les Admin</h3>
                <input type="text" id="test-admin-uid" placeholder="UID de l'utilisateur" />
                <button id="test-set-admin-button">Rendre Admin</button>
                <button id="test-remove-admin-button">Enlever Admin</button>
                <p id="test-admin-status" class="message-feedback" style="display: none;"></p>
            </div>
        </div>
    </div>
    <div id="image-lightbox" class="lightbox" style="display: none;">
      <span class="lightbox-close">&times;</span>
      <img class="lightbox-content" id="lightbox-image">
    </div>

    <script type="module">
        // --- IMPORTS FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, doc, addDoc, serverTimestamp, orderBy, getDocs, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check.js";
        import { getDoc as firebaseGetDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"; 
        
        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // --- CONFIGURATION ET INITIALISATION FIREBASE (HORS de DOMContentLoaded) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDMRyfYvujCFP3cdmm8UssoMD6crTR3Gp8",
            authDomain: "suivi-chantier-societe.firebaseapp.com",
            projectId: "suivi-chantier-societe",
            storageBucket: "suivi-chantier-societe.firebasestorage.app",
            messagingSenderId: "888449140099",
            appId: "1:888449140099:web:a11dd777d9aa2a839662b6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);

        // Initialisation de App Check immÃ©diatement
        initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider('METTEZ_VOTRE_NOUVELLE_CLE_RECAPTCHA_ICI'), // Assurez-vous d'utiliser la NOUVELLE clÃ©
          isTokenAutoRefreshEnabled: true
        });


        // --- CODE QUI MANIPULE LA PAGE (DANS DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- SÃLECTEURS D'ÃLÃMENTS ---
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            // ... (toutes vos autres fonctions et Ã©couteurs d'Ã©vÃ©nements restent ici, sans changement)
            const chantiersList = document.getElementById('chantiers-list');
            const adminSection = document.getElementById('admin-section');
            const appTitle = document.getElementById('app-title');
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxClose = document.querySelector('.lightbox-close');

            // --- GESTION DE L'AUTHENTIFICATION ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    const idTokenResult = await user.getIdTokenResult(true);
                    const isAdmin = idTokenResult.claims.admin === true;
                    
                    if (isAdmin) {
                        loadAdminDashboard();
                    } else {
                        loadClientDashboard(user);
                    }
                } else {
                    loginContainer.style.display = 'block';
                    appContainer.style.display = 'none';
                    chantiersList.innerHTML = '';
                    adminSection.style.display = 'none';
                }
            });

            // --- Collez TOUT le reste de votre code JavaScript (de "document.getElementById('login-form')..."" jusqu'Ã  la fin) ici ---
            // J'ai omis le reste pour la lisibilitÃ©, mais vous devez le garder.

        });
    </script>