<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Chantier - 2HR Habitat Rénovation</title>
    
    <style>
        :root {
            --company-orange: #E57300;
            --company-light-green: #E2EFDA;
            --company-dark-green-action: #3E8E41;
            --text-dark: #333333;
            --text-light: #FFFFFF;
            --border-color: #cccccc;
            --error-red: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .company-logo { display: block; margin: 0 auto 20px auto; max-height: 120px; width: auto; }
        .app-header { background-color: #ffffff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--company-orange); margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .app-header .company-logo { margin: 0; max-height: 50px; }
        .app-header h1 { margin: 0 20px; flex-grow: 1; font-size: 1.5em; color: var(--company-orange); }
        #login-container, #app-container { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin: 20px auto; max-width: 900px; }
        #login-container { max-width: 400px; text-align: center; }

        h2, h3, h4 { color: var(--company-orange); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 25px; }
        h2:first-child, h3:first-child, h4:first-child { margin-top: 0; }
        h4 { font-size: 1.1em; border-bottom: none; }

        input, textarea, select, button { font-family: inherit; font-size: 1em; }
        input[type="email"], input[type="password"], input[type="text"], textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; background-color: #fff; }
        textarea { min-height: 80px; resize: vertical; }

        button { background-color: var(--company-orange); color: var(--text-light); padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: background-color 0.2s ease; }
        button:hover { background-color: #D46900; }
        #logout-button { background-color: #6c757d; }
        #logout-button:hover { background-color: #5a6268; }

        .error { color: var(--error-red); background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }
        .message-feedback { padding: 10px; border-radius: 4px; margin-top: 15px; border: 1px solid transparent; }
        .message-feedback.success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .message-feedback.error { color: var(--error-red); background-color: #f8d7da; border-color: #f5c6cb; }
        
        .client-accordion { border: 1px solid #d0d0d0; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        .client-header { cursor: pointer; padding: 15px 20px; background-color: #e2efda; transition: background-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--company-dark-green-action); }
        .client-header:hover { background-color: #d4e7c7; }
        .client-header.is-admin { cursor: default; background-color: #f1f1f1; border-bottom-color: #ccc; }
        .client-header.is-admin:hover { background-color: #f1f1f1; }
        .client-header h3 { margin: 0; padding: 0; border: none; color: var(--text-dark); font-size: 1.3em; }
        .indicator { transition: transform 0.3s ease; font-size: 1.5em; color: var(--company-dark-green-action) }
        .client-header.is-open > .indicator, .chantier-header.is-open > .indicator { transform: rotate(180deg); }
        .client-body, .chantier-body { display: none; padding: 15px; }
        .chantier-item { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .chantier-item:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        
        .photos-container { display: flex; gap: 10px; margin-top: 10px; padding: 10px; overflow-x: auto; background-color: #f4f7f6; border-radius: 5px; }
        .photos-container img { height: 100px; width: auto; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
        .photos-container img:hover { transform: scale(1.05); }

        #admin-section { background-color: #fffaf5; padding: 20px; border-radius: 8px; border: 1px solid #ffe8cc; }
        .admin-subsection { margin-top: 25px; padding-top: 25px; border-top: 1px dashed #ddd; }
        .admin-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .admin-danger-zone { border: 1px solid red !important; padding: 15px; margin-top: 20px; }

        .chat-section { margin-top: 20px; border-top: 1px dashed #ddd; padding-top: 20px; }
        .chat-box { max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #f9f9f9; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 70%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .chat-message p { margin: 0; }
        .chat-message .meta { font-size: 0.75em; color: #6c757d; margin-top: 5px; }
        .message-sent { background-color: var(--company-orange); color: white; border-bottom-right-radius: 4px; align-self: flex-end; text-align: right; }
        .message-received { background-color: #e9ecef; color: #333; border-bottom-left-radius: 4px; align-self: flex-start; }
        .chat-form { display: flex; gap: 10px; margin-top: 15px; }
        .chat-form textarea { flex-grow: 1; margin: 0; }
        .chat-form button { margin-top: 0; align-self: flex-end; height: fit-content; }

        .admin-badge { background-color: var(--company-orange); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; margin-left: 10px; font-weight: bold; vertical-align: middle; }
        .lightbox { position: fixed; z-index: 1000; padding: 20px; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; overflow: auto; background-color: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; }
        .lightbox-content { margin: auto; display: block; max-width: 100%; max-height: 100%; border-radius: 8px; }
        .lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="login-container">
        <img src="images/logo.png/Nouveau logo sans Fond PNG.png" alt="Logo 2HR Habitat Rénovation" id="login-logo" class="company-logo">
        <h2>Connexion</h2>
        <form id="login-form">
            <div><label for="email">E-mail :</label><input type="email" id="email" name="email" required></div>
            <div><label for="password">Mot de passe :</label><input type="password" id="password" name="password" required></div>
            <button type="submit">Se connecter</button>
            <p id="login-error" class="error" style="display: none;"></p>
        </form>
    </div>
    <div id="app-container" style="display: none;">
        <header class="app-header">
            <img src="images/logo.png/Nouveau logo sans Fond PNG.png" alt="Logo 2HR Habitat Rénovation" id="app-logo" class="company-logo">
            <h1 id="app-title">Suivi de vos chantiers</h1>
            <button id="logout-button">Se déconnecter</button>
        </header>
        <div id="chantiers-list"></div>
        <div id="admin-section" style="display: none;">
            <h2>Outils d'Administration</h2>
            <div class="admin-subsection">
                <h3>Créer un Nouveau Client</h3>
                <form id="create-client-form">
                    <div><label for="new-client-name">Nom du client :</label><input type="text" id="new-client-name" required></div>
                    <div><label for="new-client-email">Email du client :</label><input type="email" id="new-client-email" required></div>
                    <div><label for="new-client-password">Mot de passe initial :</label><input type="text" id="new-client-password" required></div>
                    <button type="submit">Créer le Client</button>
                    <p id="create-client-status" class="message-feedback" style="display: none;"></p>
                </form>
            </div>
            <div class="admin-subsection">
                <h3>Ajouter un Nouveau Chantier</h3>
                <form id="add-chantier-form">
                    <div><label for="add-chantier-client-select">Pour le client :</label><select id="add-chantier-client-select" required></select></div>
                    <div><label for="new-chantier-address">Adresse du chantier :</label><input type="text" id="new-chantier-address" required></div>
                    <button type="submit">Ajouter le Chantier</button>
                    <p id="add-chantier-status" class="message-feedback" style="display: none;"></p>
                </form>
            </div>
            <div class="admin-danger-zone">
                <h3>Gérer les Rôles Admin</h3>
                <input type="text" id="test-admin-uid" placeholder="UID de l'utilisateur" />
                <button id="test-set-admin-button">Rendre Admin</button>
                <button id="test-remove-admin-button">Enlever Admin</button>
                <p id="test-admin-status"></p>
            </div>
        </div>
    </div>
    <div id="image-lightbox" class="lightbox" style="display: none;">
      <span class="lightbox-close">&times;</span>
      <img class="lightbox-content" id="lightbox-image">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, doc, addDoc, serverTimestamp, orderBy, getDocs, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check.js";
        import { getDoc as firebaseGetDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyDMRyfYvujCFP3cdmm8UssoMD6crTR3Gp8", // Remplacez par votre clé API si différente
                authDomain: "suivi-chantier-societe.firebaseapp.com",
                projectId: "suivi-chantier-societe",
                storageBucket: "suivi-chantier-societe.firebasestorage.app",
                messagingSenderId: "888449140099",
                appId: "1:888449140099:web:a11dd777d9aa2a839662b6"
            };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Initialisation d'App Check (sécurité)
            initializeAppCheck(app, {
              provider: new ReCaptchaV3Provider('6LfDVkYrAAAAACsz-wqYEudXc32pkr38Oy6fPwFU'), // Remplacez par votre clé reCAPTCHA v3
              isTokenAutoRefreshEnabled: true
            });

            // --- SÉLECTEURS D'ÉLÉMENTS ---
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const chantiersList = document.getElementById('chantiers-list');
            const adminSection = document.getElementById('admin-section');
            const appTitle = document.getElementById('app-title');

            // --- GESTION DE L'AUTHENTIFICATION ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    const idTokenResult = await user.getIdTokenResult(true);
                    const isAdmin = idTokenResult.claims.admin === true;
                    
                    if (isAdmin) {
                        loadAdminDashboard();
                    } else {
                        loadClientDashboard(user);
                    }
                } else {
                    loginContainer.style.display = 'block';
                    appContainer.style.display = 'none';
                    chantiersList.innerHTML = ''; // Vider la liste
                    adminSection.style.display = 'none';
                }
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const errorEl = document.getElementById('login-error');
                errorEl.style.display = 'none';
                errorEl.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, email.value, password.value);
                } catch (error) {
                    errorEl.textContent = 'Erreur : Identifiants incorrects ou problème de connexion.';
                    errorEl.style.display = 'block';
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            
            // --- FONCTIONNALITÉS DU CHAT (NOUVEAU / MODIFIÉ) ---

            /**
             * Affiche les messages dans une boîte de chat.
             * @param {QuerySnapshot} snapshot - Le snapshot des messages de Firestore.
             * @param {HTMLElement} chatBox - L'élément DOM où afficher les messages.
             * @param {String} currentUserId - L'UID de l'utilisateur actuellement connecté.
             */
            function renderMessages(snapshot, chatBox, currentUserId) {
                chatBox.innerHTML = ''; // Vider la boîte de chat
                if (snapshot.empty) {
                    chatBox.innerHTML = '<p style="text-align: center; color: #888;">Aucun message. Commencez la conversation !</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const messageEl = document.createElement('div');
                    messageEl.classList.add('chat-message');

                    const senderClass = message.senderId === currentUserId ? 'message-sent' : 'message-received';
                    messageEl.classList.add(senderClass);
                    
                    const date = message.timestamp?.toDate ? message.timestamp.toDate().toLocaleString('fr-FR') : 'Envoi...';

                    messageEl.innerHTML = `
                        <p>${message.text}</p>
                        <div class="meta">
                            <strong>${message.senderName || 'Anonyme'}</strong> - ${date}
                        </div>
                    `;
                    chatBox.appendChild(messageEl);
                });
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll vers le bas
            }

            /**
             * Met en place l'écouteur de messages pour un chantier donné.
             * @param {String} chantierId - L'ID du chantier.
             * @param {String} clientId - L'ID du client propriétaire du chantier.
             */
            function setupChatListener(chantierId, clientId) {
                const chatBox = document.getElementById(`chat-box-${chantierId}`);
                if (chatBox.dataset.chatLoaded === 'true') return; // Déjà chargé

                const messagesRef = collection(db, 'clients', clientId, 'chantier', chantierId, 'messages');
                const q = query(messagesRef, orderBy('timestamp'));

                onSnapshot(q, (snapshot) => {
                    renderMessages(snapshot, chatBox, auth.currentUser.uid);
                }, (error) => {
                    console.error("Erreur d'écoute du chat:", error);
                    chatBox.innerHTML = '<p class="error">Impossible de charger les messages.</p>';
                });

                chatBox.dataset.chatLoaded = 'true';
            }

            // --- FONCTION DE RENDU PRINCIPALE ---

            function renderChantier(chantierDoc, isAdmin, clientInfo) {
                const chantierData = chantierDoc.data();
                const chantierId = chantierDoc.id;
                const clientId = clientInfo.id;
                
                const chantierItem = document.createElement('div');
                chantierItem.classList.add('chantier-item');
                
                const title = isAdmin ? `<h4>Chantier : ${chantierData.adresse || 'N/A'}</h4>` : `<h3>Chantier à : ${chantierData.adresse || 'Adresse non spécifiée'}</h3>`;
                
                chantierItem.innerHTML = `
                    <div class="chantier-header" data-chantier-id="${chantierId}" data-client-id="${clientId}" data-target="body-${chantierId}">
                        <div class="title-content">${title}</div>
                        <span class="indicator">▼</span>
                    </div>
                    <div class="chantier-body" id="body-${chantierId}">
                        <div id="details-display-${chantierId}">
                           <p><strong>Jours d'intervention :</strong> ${chantierData.joursIntervention ? chantierData.joursIntervention.join(', ') : 'Non définis'}</p>
                           <p><strong>Avancement :</strong> ${chantierData.pourcentageAvancement || 0}%</p>
                           ${isAdmin ? `<button class="edit-chantier-button" data-chantier-id="${chantierId}">Modifier</button>` : ''}
                        </div>
                        <form id="edit-form-${chantierId}" style="display:none;" class="chantier-edit-form" data-client-id="${clientId}">
                            <label>Jours d'intervention (séparés par une virgule):</label>
                            <input type="text" class="jours-intervention-input" value="${chantierData.joursIntervention ? chantierData.joursIntervention.join(', ') : ''}">
                            <label>Avancement (%):</label>
                            <input type="number" min="0" max="100" class="avancement-input" value="${chantierData.pourcentageAvancement || 0}">
                            <button type="submit" class="save-chantier-button" data-chantier-id="${chantierId}" data-client-id="${clientId}">Sauvegarder</button>
                            <button type="button" class="cancel-edit-button">Annuler</button>
                        </form>
                        <div class="chat-section">
                            <h4>Questions & Réponses</h4>
                            <div class="chat-box" id="chat-box-${chantierId}"><p style="text-align: center; color: #888;">Cliquez pour déplier et charger les messages.</p></div>
                            <form class="chat-form" data-chantier-id="${chantierId}" data-client-id="${clientId}">
                                <textarea name="messageText" required placeholder="Votre message..."></textarea>
                                <button type="submit">Envoyer</button>
                            </form>
                        </div>
                    </div>
                `;
                return chantierItem;
            }
            
            // --- TABLEAUX DE BORD (DASHBOARDS) ---
            
            async function loadAdminDashboard() {
                appTitle.textContent = "Administration des Chantiers";
                adminSection.style.display = 'block';
                chantiersList.innerHTML = '<h2>Tous les Comptes Clients</h2>';
                try {
                    const clientsSnapshot = await getDocs(collection(db, 'clients'));
                    if (clientsSnapshot.empty) {
                        chantiersList.innerHTML += '<p>Aucun compte client trouvé.</p>';
                        return;
                    }
                    
                    clientsSnapshot.forEach(clientDoc => {
                        const clientData = clientDoc.data();
                        const isThisUserAdmin = clientData.role === 'admin';
                        const clientInfo = { id: clientDoc.id, nom: clientData.nom || `Compte ${clientDoc.id.substring(0,5)}` };
                        
                        const accountWrapper = document.createElement('div');
                        accountWrapper.classList.add('client-accordion');
                        
                        let headerClass = "client-header";
                        let headerContent = `<h3>${clientInfo.nom}</h3>`;
                        if (isThisUserAdmin) {
                            headerClass += " is-admin";
                            headerContent = `<h3>${clientInfo.nom} <span class="admin-badge">Admin</span></h3>`;
                        }
                        
                        accountWrapper.innerHTML = `
                            <div class="${headerClass}" data-target="client-body-${clientDoc.id}">
                                ${headerContent}
                                ${!isThisUserAdmin ? '<span class="indicator">▼</span>' : ''}
                            </div>
                            <div class="client-body" id="client-body-${clientDoc.id}"></div>`;
                        chantiersList.appendChild(accountWrapper);
                        
                        if (!isThisUserAdmin) {
                            const chantiersContainer = accountWrapper.querySelector('.client-body');
                            const chantiersRef = collection(db, 'clients', clientDoc.id, 'chantier');
                            onSnapshot(chantiersRef, (chantiersSnapshot) => {
                                 chantiersContainer.innerHTML = '';
                                 if(chantiersSnapshot.empty) {
                                     chantiersContainer.innerHTML = '<p>Ce client n\'a aucun chantier.</p>';
                                 } else {
                                     chantiersSnapshot.forEach(chantierDoc => {
                                         chantiersContainer.appendChild(renderChantier(chantierDoc, true, clientInfo));
                                     });
                                 }
                            });
                        }
                    });
                    loadClientListForAdminForms();
                } catch(error) {
                    console.error("Erreur admin:", error);
                    chantiersList.innerHTML = `<p class="error">Erreur de chargement du tableau de bord: ${error.message}</p>`;
                }
            }

            async function loadClientDashboard(user) {
                appTitle.textContent = "Suivi de vos chantiers";
                adminSection.style.display = 'none';
                chantiersList.innerHTML = '';
                
                try {
                    const clientDocRef = doc(db, 'clients', user.uid);
                    const clientDocSnap = await firebaseGetDoc(clientDocRef);
                    const clientInfo = clientDocSnap.exists() ? 
                        { id: user.uid, nom: clientDocSnap.data().nom } : 
                        { id: user.uid, nom: 'Client' };

                    const chantiersRef = collection(db, 'clients', user.uid, 'chantier');
                    onSnapshot(chantiersRef, (chantiersSnapshot) => {
                         chantiersList.innerHTML = '';
                         if(chantiersSnapshot.empty) {
                             chantiersList.innerHTML = '<p>Vous n\'avez actuellement aucun chantier en cours.</p>';
                         } else {
                             chantiersSnapshot.forEach(chantierDoc => {
                                 chantiersList.appendChild(renderChantier(chantierDoc, false, clientInfo));
                             });
                         }
                    });
                } catch(error) {
                    console.error("Erreur client:", error);
                    chantiersList.innerHTML = `<p class="error">Erreur de chargement de vos chantiers: ${error.message}</p>`;
                }
            }
            
            // --- GESTION DES ÉVÉNEMENTS ---

            // Écouteur principal pour les clics (accordéons, boutons modifier/annuler/sauvegarder)
            chantiersList.addEventListener('click', async (e) => {
                const header = e.target.closest('.client-header, .chantier-header');
                
                // Gérer l'ouverture/fermeture des accordéons
                if (header && !header.classList.contains('is-admin')) {
                    const body = document.getElementById(header.dataset.target);
                    if (body) {
                        const isOpen = body.style.display === 'block';
                        body.style.display = isOpen ? 'none' : 'block';
                        header.classList.toggle('is-open', !isOpen);

                        // Charger le chat si on ouvre le chantier
                        if (!isOpen && header.classList.contains('chantier-header')) {
                            setupChatListener(header.dataset.chantierId, header.dataset.clientId);
                        }
                    }
                }
                
                const target = e.target;
                // Gérer le mode édition des chantiers
                if(target.matches('.edit-chantier-button')) {
                    const chantierId = target.dataset.chantierId;
                    document.getElementById(`details-display-${chantierId}`).style.display = 'none';
                    document.getElementById(`edit-form-${chantierId}`).style.display = 'block';
                }
                if(target.matches('.cancel-edit-button')) {
                    const form = target.closest('.chantier-edit-form');
                    const chantierId = form.id.replace('edit-form-', '');
                    form.style.display = 'none';
                    document.getElementById(`details-display-${chantierId}`).style.display = 'block';
                }
                if (target.matches('.save-chantier-button')) {
                    e.preventDefault();
                    const form = target.closest('.chantier-edit-form');
                    const chantierId = target.dataset.chantierId;
                    const clientId = target.dataset.clientId;
                    const joursInput = form.querySelector('.jours-intervention-input').value;
                    const avancement = form.querySelector('.avancement-input').value;
                    const jours = joursInput.split(',').map(s => s.trim()).filter(Boolean);
                    const chantierRef = doc(db, 'clients', clientId, 'chantier', chantierId);
                    await updateDoc(chantierRef, { joursIntervention: jours, pourcentageAvancement: Number(avancement) });
                    form.style.display = 'none';
                    document.getElementById(`details-display-${chantierId}`).style.display = 'block';
                }
            });

            // Écouteur pour l'envoi de messages de chat
            chantiersList.addEventListener('submit', async (e) => {
                if (!e.target.matches('.chat-form')) return;
                e.preventDefault();
                
                const form = e.target;
                const textarea = form.querySelector('textarea');
                const text = textarea.value.trim();
                if (!text) return;

                const { chantierId, clientId } = form.dataset;
                const user = auth.currentUser;
                
                if (!user) {
                    alert("Vous devez être connecté pour envoyer un message.");
                    return;
                }

                const idTokenResult = await user.getIdTokenResult();
                const senderName = idTokenResult.claims.admin ? 'Admin' : (await firebaseGetDoc(doc(db, 'clients', user.uid))).data().nom;

                const messagesRef = collection(db, 'clients', clientId, 'chantier', chantierId, 'messages');
                try {
                    await addDoc(messagesRef, {
                        text: text,
                        timestamp: serverTimestamp(),
                        senderId: user.uid,
                        senderName: senderName || 'Utilisateur'
                    });
                    form.reset();
                } catch (error) {
                    console.error("Erreur d'envoi du message:", error);
                    alert("Le message n'a pas pu être envoyé.");
                }
            });

            // --- FONCTIONS ET ÉVÉNEMENTS D'ADMINISTRATION ---

            async function loadClientListForAdminForms() {
                try {
                    const clientsSnapshot = await getDocs(query(collection(db, 'clients')));
                    const select = document.getElementById('add-chantier-client-select');
                    select.innerHTML = '<option value="">-- Sélectionnez un client --</option>';
                    clientsSnapshot.forEach(doc => {
                        // N'ajoute que les documents qui ne sont PAS des admins
                        if (!doc.data().role) { 
                            const option = new Option(doc.data().nom || doc.id, doc.id);
                            select.add(option);
                        }
                    });
                } catch(error) {
                    console.error("Impossible de charger la liste des clients:", error);
                }
            }

            document.getElementById('add-chantier-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = document.getElementById('add-chantier-status');
                const clientId = document.getElementById('add-chantier-client-select').value;
                const address = document.getElementById('new-chantier-address').value;
                if (!clientId || !address) {
                    statusEl.textContent = "Veuillez sélectionner un client et entrer une adresse.";
                    statusEl.style.display = 'block';
                    return;
                }
                try {
                    const clientChantierRef = collection(db, 'clients', clientId, 'chantier');
                    await addDoc(clientChantierRef, { adresse: address, pourcentageAvancement: 0, joursIntervention: [] });
                    statusEl.textContent = "Chantier ajouté avec succès !";
                    statusEl.className = 'message-feedback success';
                    statusEl.style.display = 'block';
                    e.target.reset();
                    setTimeout(() => statusEl.style.display = 'none', 4000);
                } catch(error) {
                    statusEl.textContent = "Erreur : " + error.message;
                    statusEl.className = 'message-feedback error';
                }
            });

            // NOTE: La logique pour 'create-client-form' et la gestion des admins
            // nécessite des Cloud Functions que nous avons discutées précédemment.
            // L'interface est là, mais le code JS pour appeler les fonctions n'est pas inclus ici.

        });
    </script>
</body>
</html>