<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Chantier - 2HR Habitat Rénovation</title>
    
    <!-- ====================================================== -->
    <!--   CSS COMPLET INTÉGRÉ DANS LE HTML                     -->
    <!-- ====================================================== -->
    <style>
        :root {
            --company-orange: #E57300;
            --company-light-green: #E2EFDA;
            --company-dark-green-action: #3E8E41;
            --text-dark: #333333;
            --text-light: #FFFFFF;
            --border-color: #cccccc;
            --error-red: #dc3545;
            --success-green-bg: #d4edda;
            --success-green-border: #c3e6cb;
            --success-green-text: #155724;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .company-logo { display: block; margin: 0 auto 20px auto; max-height: 120px; width: auto; }
        .app-header { background-color: #ffffff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--company-orange); margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .app-header .company-logo { margin: 0; max-height: 50px; }
        .app-header h1 { margin: 0 20px; flex-grow: 1; font-size: 1.5em; color: var(--company-orange); }

        #login-container, #app-container { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin: 20px auto; max-width: 900px; }
        #login-container { max-width: 400px; text-align: center; }

        h2, h3 { color: var(--company-orange); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 25px; }
        h2:first-child, h3:first-child { margin-top: 0; }

        input[type="email"], input[type="password"], input[type="text"], textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; background-color: #fff; font-size: 1em; }
        textarea { min-height: 120px; resize: vertical; }

        button { background-color: var(--company-orange); color: var(--text-light); padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; margin-top: 10px; transition: background-color 0.2s ease, transform 0.1s ease; }
        button:hover { background-color: #D46900; }
        button:active { transform: scale(0.98); }
        #logout-button { background-color: #6c757d; }
        #logout-button:hover { background-color: #5a6268; }

        .message-feedback { padding: 10px; border-radius: 4px; margin-top: 15px; border: 1px solid transparent; }
        .message-feedback.success { color: var(--success-green-text); background-color: var(--success-green-bg); border-color: var(--success-green-border); }
        .message-feedback.error { color: var(--error-red); background-color: #f8d7da; border-color: #f5c6cb; }
        .message-feedback.info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }

        .chantier-item { border: 1px solid #e0e0e0; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #fdfdfd; }
        .photos-container { display: flex; gap: 10px; margin-top: 10px; padding: 10px; overflow-x: auto; background-color: #f4f7f6; border-radius: 5px; }
        .photos-container img { height: 100px; width: auto; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
        .photos-container img:hover { transform: scale(1.05); }

        #admin-section { background-color: #fffaf5; padding: 20px; border-radius: 8px; border: 1px solid #ffe8cc; }
        .admin-subsection { margin-top: 25px; padding-top: 25px; border-top: 1px dashed #ddd; }
        .admin-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .question-item, .admin-question-item { border: 1px solid #eee; background-color: #fff; padding: 15px; margin-bottom: 15px; border-radius: 5px; position: relative; }
        .reponse-admin { background-color: var(--company-light-green); border-left: 3px solid var(--company-dark-green-action); padding: 10px; margin-top: 10px; border-radius: 3px; }
        .question-from-admin { background-color: #fff3cd; border-left: 3px solid #ffeeba; padding: 10px; margin-top: 10px; border-radius: 3px; }

        #admin-client-list ul { list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; }
        #admin-client-list li { background-color: #f8f9fa; padding: 10px; border-bottom: 1px solid #dee2e6; font-family: 'Courier New', Courier, monospace; }
        #admin-client-list li:last-child { border-bottom: none; }

        .admin-danger-zone { border: 1px solid red !important; }

        /* Styles pour le statut des questions */
        .question-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-ouverte {
            background-color: #ffc107; /* Jaune/Orange */
            color: #333;
        }
        .status-resolue {
            background-color: var(--company-dark-green-action); /* Vert */
            color: white;
        }
        .resolve-button {
            background-color: #17a2b8; /* Bleu info */
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            margin-top: 10px;
        }
        .resolve-button:hover {
            background-color: #138496;
        }

        .lightbox { position: fixed; z-index: 1000; padding: 20px; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; overflow: auto; background-color: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; }
        .lightbox-content { margin: auto; display: block; max-width: 100%; max-height: 100%; border-radius: 8px; animation-name: lightbox-zoom; animation-duration: 0.6s; }
        @keyframes lightbox-zoom { from {transform: scale(0.1)} to {transform: scale(1)} }
        .lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; }
        .lightbox-close:hover, .lightbox-close:focus { color: #bbb; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <!-- Contenu HTML inchangé... -->
    <div id="login-container">
        <img src="images/logo.png/Nouveau logo sans Fond PNG.png" alt="Logo 2HR Habitat Rénovation" id="login-logo" class="company-logo">
        <h2>Connexion</h2>
        <form id="login-form">
            <div><label for="email">E-mail :</label><input type="email" id="email" name="email" required></div>
            <div><label for="password">Mot de passe :</label><input type="password" id="password" name="password" required></div>
            <button type="submit">Se connecter</button>
            <p id="login-error" class="error" style="display: none;"></p>
        </form>
    </div>
    <div id="app-container" style="display: none;">
        <header class="app-header">
            <img src="images/logo.png/Nouveau logo sans Fond PNG.png" alt="Logo 2HR Habitat Rénovation" id="app-logo" class="company-logo">
            <h1 id="app-title">Suivi de vos chantiers</h1>
            <button id="logout-button">Se déconnecter</button>
        </header>
        <div id="chantiers-list"></div>
        <div id="client-question-section">
            <h2>Vos Questions</h2>
            <div id="questions-container"></div>
            <h2>Poser une nouvelle question</h2>
            <form id="question-form">
                <textarea id="question-text" placeholder="Écrivez votre question ici..."></textarea>
                <button type="submit">Envoyer la question</button>
                <p id="question-confirmation" class="message-feedback" style="display: none;"></p>
            </form>
        </div>
        <div id="admin-section" style="display: none;">
            <h2>Section Administration</h2>
            <div class="admin-subsection"><h3>Liste des Clients</h3><div id="admin-client-list"></div></div>
            <div class="admin-subsection">
                <h3>Ajouter une photo à un chantier</h3>
                <form id="upload-photo-form">
                    <div><label for="client-uid-select">Sélectionner un Client :</label><select id="client-uid-select" required></select></div>
                    <div><label for="chantier-id-select">Sélectionner un Chantier :</label><select id="chantier-id-select" required disabled></select></div>
                    <div><label for="photo-file">Sélectionner une photo :</label><input type="file" id="photo-file" accept="image/*" required></div>
                    <button type="submit">Envoyer la photo</button>
                    <p id="upload-status" class="message-feedback" style="display: none;"></p>
                </form>
            </div>
            <div class="admin-subsection">
                <h3>Poser une question à un client</h3>
                <form id="admin-question-form">
                     <div><label for="target-client-uid-select">Sélectionner un Client Cible :</label><select id="target-client-uid-select" required></select></div>
                     <div><label for="admin-question-text">Votre Question :</label><textarea id="admin-question-text" placeholder="Écrivez votre question ici..."></textarea></div>
                    <button type="submit">Envoyer au client</button>
                    <p id="admin-question-confirmation" class="message-feedback" style="display: none;"></p>
                </form>
            </div>
            <div class="admin-subsection"><h3>Questions de tous les clients</h3><div id="admin-questions-container"></div></div>
            <div class="admin-subsection admin-danger-zone">
                <h3>Gérer les Rôles Admin</h3>
                <input type="text" id="test-admin-uid" placeholder="UID de l'utilisateur" />
                <button id="test-set-admin-button">Rendre Admin</button>
                <button id="test-remove-admin-button">Enlever Admin</button>
                <p id="test-admin-status"></p>
            </div>
        </div>
    </div>
    <div id="image-lightbox" class="lightbox" style="display: none;">
      <span class="lightbox-close">&times;</span>
      <img class="lightbox-content" id="lightbox-image">
    </div>

    <!-- ====================================================== -->
    <!--   JAVASCRIPT COMPLET INTÉGRÉ DANS LE HTML            -->
    <!-- ====================================================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, getDocs, doc, addDoc, updateDoc, serverTimestamp, orderBy as firestoreOrderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        import { getDoc as firebaseGetDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyDMRyfYvujCFP3cdmm8UssoMD6crTR3Gp8",
                authDomain: "suivi-chantier-societe.firebaseapp.com",
                projectId: "suivi-chantier-societe",
                storageBucket: "suivi-chantier-societe.firebasestorage.app",
                messagingSenderId: "888449140099",
                appId: "1:888449140099:web:a11dd777d9aa2a839662b6",
                measurementId: "G-2KTWHDGT3S"
            };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);
            initializeAppCheck(app, {
              provider: new ReCaptchaV3Provider('6LfDVkYrAAAAACsz-wqYEudXc32pkr38Oy6fPwFU'),
              isTokenAutoRefreshEnabled: true
            });

            const loginForm = document.getElementById('login-form');
            const appContainer = document.getElementById('app-container');
            const logoutButton = document.getElementById('logout-button');
            const chantiersList = document.getElementById('chantiers-list');
            const clientQuestionSection = document.getElementById('client-question-section');
            const questionsContainer = document.getElementById('questions-container');
            const questionForm = document.getElementById('question-form');
            const adminSection = document.getElementById('admin-section');
            const adminQuestionsContainer = document.getElementById('admin-questions-container');
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try { await signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value); } catch (error) { document.getElementById('login-error').textContent = 'Erreur: Identifiants incorrects.'; }
            });
            logoutButton.addEventListener('click', () => signOut(auth));

            function setupAdminEventListeners() { /* ... */ } // Placeholder
            function openLightbox(url) { /* ... */ } // Placeholder
            
            async function renderQuestions(docs, container, isAdminView) {
                if (!container) return;
                container.innerHTML = '';
                const questionsData = docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                if (questionsData.length === 0) {
                    container.innerHTML = `<p>${isAdminView ? 'Aucune question de client.' : 'Aucune question.'}</p>`;
                    return;
                }

                let users = {};
                if (isAdminView) {
                    const userIds = [...new Set(questionsData.map(d => d.userId).filter(Boolean))];
                    const userDocs = await Promise.all(userIds.map(id => firebaseGetDoc(doc(db, 'clients', id))));
                    userDocs.forEach(d => { if(d.exists()) users[d.id] = d.data().nom || 'Client inconnu'; });
                }
                
                questionsData.forEach(questionData => {
                    if (isAdminView && !questionData.userId) return;
                    
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question-item');
                    if (questionData.askedBy) questionDiv.classList.add('question-from-admin');
                    
                    const header = isAdminView ? `<p><strong>Client :</strong> ${users[questionData.userId] || 'Inconnu'} (<code>${questionData.userId}</code>)</p>` : '';
                    const status = questionData.status || 'ouverte';
                    const statusBadge = `<span class="question-status status-${status}">${status}</span>`;
                    
                    let actionButton = '';
                    if (!isAdminView && status === 'ouverte' && questionData.reponse) {
                        actionButton = `<button class="resolve-button" data-question-id="${questionData.id}">Marquer comme résolue</button>`;
                    } else if (isAdminView && !questionData.reponse) {
                        actionButton = `<button class="reply-button" data-question-id="${questionData.id}">Répondre</button>`;
                    }
                    
                    questionDiv.innerHTML = `
                        ${statusBadge}
                        ${header}
                        <p><strong>Question :</strong> ${questionData.question}</p>
                        <p><em>Posée le : ${new Date(questionData.timestamp.seconds * 1000).toLocaleString()}</em></p>
                        ${questionData.reponse ? `<div class="reponse-admin"><p><strong>Réponse :</strong> ${questionData.reponse}</p>${isAdminView ? `<button class="edit-reply-button" data-question-id="${questionData.id}">Modifier</button>` : ''}</div>` : ''}
                        ${actionButton}
                        ${isAdminView ? `<div id="reply-form-${questionData.id}" style="display: none;"><textarea>${questionData.reponse || ''}</textarea><button class="submit-reply-button" data-question-id="${questionData.id}">Envoyer</button></div>` : ''}
                    `;
                    container.appendChild(questionDiv);
                });
            }
            
            // Le reste de votre code ici...
            // GESTIONNAIRE D'ÉTAT D'AUTHENTIFICATION, etc.
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    const idTokenResult = await user.getIdTokenResult(true);
                    const isAdmin = idTokenResult.claims.admin === true;

                    if (isAdmin) {
                        appTitle.textContent = "Espace Administration";
                        adminSection.style.display = 'block';
                        clientQuestionSection.style.display = 'none';
                        // chargez ici les données pour l'admin
                        // ... loadAdminQuestions, loadClientListForAdmin
                    } else {
                        appTitle.textContent = "Suivi de vos chantiers";
                        adminSection.style.display = 'none';
                        clientQuestionSection.style.display = 'block';
                        // chargez ici les données pour le client
                        // ... loadClientChantiers, loadClientQuestions
                    }
                } else {
                    loginContainer.style.display = 'block';
                    appContainer.style.display = 'none';
                }
            });
            
            appContainer.addEventListener('click', async (event) => {
                const target = event.target;
                if(target.matches('.resolve-button')) {
                    const questionId = target.dataset.questionId;
                    const questionRef = doc(db, 'questions', questionId);
                    await updateDoc(questionRef, { status: 'resolue' });
                }
                // ... autre logique d'événement
            });
            
            questionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const questionTextEl = document.getElementById('question-text');
                if (questionTextEl.value.trim() && auth.currentUser) {
                    await addDoc(collection(db, 'questions'), {
                        userId: auth.currentUser.uid,
                        question: questionTextEl.value.trim(),
                        timestamp: serverTimestamp(),
                        status: 'ouverte'
                    });
                    questionTextEl.value = '';
                }
            });

        });
    </script>
</body>
</html>
